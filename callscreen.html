<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Now Serving</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      background: #F3E6D3;
      color: white;
      padding-top: 60px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      min-height: 100vh;
      overflow: hidden;
    }
    #ticket {
      font-size: 80px;
      margin-bottom: 20px;
      color: black;
    }
    #window {
      font-size: 48px;
      color: #ffa500;
    }
    #unlocked {
      color: lime;
      margin-top: 20px;
    }
    audio {
      display: none;
    }

    .blink {
      animation: blink-animation 0.3s steps(1, start) 6;
    }

    @keyframes blink-animation {
      50% {
        opacity: 0;
      }
    }

    /* âœ… Active windows grid at bottom */
    #history {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0,0,0,0.85);
      padding: 20px;
    }
    #history h2 {
      font-size: 22px;
      margin-bottom: 10px;
      text-align: center;
      color: #ffa500;
    }
    #history-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, auto);
      gap: 10px;
    }
    .history-card {
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 6px;
      font-size: 18px;
      transition: background 0.3s;
    }
    .history-card strong {
      display: block;
      font-size: 22px;
      color: #ffa500;
    }

    /* âœ… Highlight new ticket */
    .new-ticket {
      animation: new-ticket-blink 1s ease-in-out 3;
    }
    @keyframes new-ticket-blink {
      0%, 100% { background: rgba(255,255,255,0.1); }
      50% { background: rgba(255,165,0,0.7); }
    }

    /* âœ… Credit label */
    #credit {
      position: fixed;
      bottom: 5px;
      left: 10px;
      font-size: 14px;
      color: #ccc;
    }
  </style>
</head>
<body>
  <img src="logo-black-1.png" alt="Header Image" style="max-width: 300px; height: auto; margin: 40px auto; display: block;">
  <div id="ticket">Now Serving: -</div>
  <div id="window">At Window: -</div>
  <div id="unlocked">ðŸ”‡ Tap anywhere to enable announcements</div>

  <audio id="ding" preload="auto">
    <source src="ding.ogg" type="audio/ogg">
  </audio>

  <!-- âœ… Active Windows Grid -->
  <div id="history">
    <h2>Currently Serving</h2>
    <div id="history-grid"></div>
  </div>
  <div id="credit">Solution by jmactivations.com</div>

  <script>
    const API_BASE_URL = "https://qpayapi.jmactivations.com"; // <-- Change this to your actual API
    let selectedVoice = null;
    let audioUnlocked = false;

    // âœ… Track active windows with update order
    const activeTickets = new Map(); // window -> ticket

    document.body.addEventListener("click", () => {
      if (!audioUnlocked) {
        const dummy = new Audio();
        dummy.play().catch(() => {});
        audioUnlocked = true;
        document.getElementById("unlocked").style.display = "none";
        selectedVoice = pickBestEnglishVoice();
        console.log("âœ… Using voice:", selectedVoice?.name);
        pollAnnouncements();
      }
    }, { once: true });

    function pickBestEnglishVoice() {
      const voices = speechSynthesis.getVoices();
      const englishVoices = voices.filter(v => v.lang.startsWith("en"));

      // âœ… Prioritize Google US English
      return englishVoices.find(v => v.name.includes("Google US English")) ||
             englishVoices.find(v => v.name.includes("Samantha")) ||
             englishVoices.find(v => v.name.includes("Bubbles")) ||
             englishVoices[0];
    }

    function triggerSpeech(text) {
      return new Promise(resolve => {
        if (!selectedVoice) {
          console.warn("âŒ No voice selected!");
          resolve();
          return;
        }

        const utter = new SpeechSynthesisUtterance(text);
        utter.voice = selectedVoice;
        utter.lang = "en-US"; // Force en-US

        utter.onend = () => {
          setTimeout(() => resolve(), 500);
        };

        console.log("ðŸ“£ Speaking:", text, "with", utter.voice?.name);
        speechSynthesis.speak(utter);
      });
    }

    function playDing() {
      return new Promise(resolve => {
        const ding = document.getElementById("ding");
        ding.onended = resolve;
        ding.onerror = resolve;
        ding.play().catch(resolve);
      });
    }

    function updateHistory(ticket, window) {
      // âœ… Remove window if it already exists, so we can re-insert at front
      if (activeTickets.has(window)) {
        activeTickets.delete(window);
      }
      // Insert window-ticket pair at the front
      const newMap = new Map([[window, ticket]]);
      for (const [w, t] of activeTickets) {
        newMap.set(w, t);
      }
      // Replace with trimmed map (max 6)
      activeTickets.clear();
      let count = 0;
      for (const [w, t] of newMap) {
        if (count < 6) {
          activeTickets.set(w, t);
          count++;
        } else break;
      }

      // Render grid
      const grid = document.getElementById("history-grid");
      grid.innerHTML = "";

      let i = 0;
      for (const [win, t] of activeTickets) {
        const card = document.createElement("div");
        card.className = "history-card";
        card.innerHTML = `<strong>${t}</strong>Window ${win}`;

        if (i === 0) {
          card.classList.add("new-ticket"); // highlight newest
        }

        grid.appendChild(card);
        i++;
      }
    }

    async function pollAnnouncements() {
      while (audioUnlocked) {
        try {
          const response = await fetch(`${API_BASE_URL}/latest-announcement`);
          if (response.status === 204) {
            await delay(2000);
            continue;
          }

          const data = await response.json();
          if (!data || !data.ticket_number || !data.desk_name) continue;

          // Update main display
          document.getElementById("ticket").innerText =
            "Now Serving: " + data.ticket_number;
          document.getElementById("window").innerText =
            "At Window: " + data.desk_name;

          // Blink effect
          const ticketEl = document.getElementById("ticket");
          const windowEl = document.getElementById("window");
          ticketEl.classList.remove("blink"); void ticketEl.offsetWidth; ticketEl.classList.add("blink");
          windowEl.classList.remove("blink"); void windowEl.offsetWidth; windowEl.classList.add("blink");

          // âœ… Update active windows
          updateHistory(data.ticket_number, data.desk_name);

          // Speak
          const prefix = data.ticket_number.replace(/[0-9]/g, '');
          const number = parseInt(data.ticket_number.replace(/[^0-9]/g, ''), 10);
          const message = `Customer number ${prefix} ${number}, window number ${data.desk_name}`;

          await playDing();
          await triggerSpeech(message);
        } catch (err) {
          console.error("âŒ Error fetching announcement:", err);
          await delay(3000);
        }
      }
    }

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    speechSynthesis.onvoiceschanged = () => {
      if (!selectedVoice && audioUnlocked) {
        selectedVoice = pickBestEnglishVoice();
        console.log("âœ… Voice loaded:", selectedVoice?.name);
      }
    };
  </script>
</body>
</html>